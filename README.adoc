// Asciidoc Cheat Sheet: https://github.com/powerman/asciidoc-cheatsheet
// Asciidoc Manaual: https://asciidoctor.org/docs/user-manual/

:doctitle: Data Collector

ifndef::env-github[]
:doctype: book
:page-layout: docs
:numbered:
:toc: left
:toclevels: 3
:factory-ref: https://github.com/asciidoctor/asciidoctor-stylesheet-factory
:uri-svgo: https://github.com/svg/svgo
//:source-highlighter: highlightjs
:source-highlighter: coderay
:coderay-linenums-mode: inline
:coderay-css: class
:icons: font
endif::[]

ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
:toc-placement: preamble
endif::[]

[NOTE]
====
This documentation is work in progress!
====

The Data Collector (DC) is a framework for consuming REST APIs where collected data is written to streams. The DC executes a declarative Specification at runtime that describes how data should be collected. The Specification is built using a well defined DSL.

== Getting started

=== DSL

[source,java,linenum]
----
SpecificationBuilder feedBuilder = Specification.start("", "loop")
        .configure(context()
                .topic("topic")
                .variable("nextPosition", "${contentStream.hasLastPosition() ? contentStream.lastPosition() : 1}")
        )
        .function(paginate("loop")
                .variable("fromPosition", "${nextPosition}")
                .addPageContent()
                .iterate(execute("page"))
                .prefetchThreshold(15)
                .until(whenVariableIsNull("nextPosition"))
        )
        .function(get("page")
                .url("http://example.com/feed?pos=${fromPosition}&size=10")
                .validate(status().success(200, 299))
                .pipe(sequence(xpath("/feed/entry"))
                        .expected(xpath("/entry/id"))
                )
                .pipe(nextPage()
                        .output("nextPosition", regex(xpath("/feed/link[@rel=\"next\"]/@href"), "(?<=[?&]pos=)[^&]*"))
                )
                .pipe(parallel(xpath("/feed/entry"))
                        .variable("position", xpath("/entry/id"))
                        .pipe(addContent("${position}", "entry"))
                        .pipe(publish("${position}"))
                )
                .returnVariables("nextPosition")
        );
----

=== Run

[source,java,linenum]
----
Worker.newBuilder()
        .configuration(Map.of(
                "content.stream.connector", "rawdata",
                "rawdata.client.provider", "memory")
        )
        .specification(feedBuilder)
        .printExecutionPlan()
        .build()
        .run();
----

ifdef::env-github[]
= Table of Contents

. link:docs/administration.adoc[Administration]
endif::[]

ifndef::env-github[]
:leveloffset: +1
include::docs/administration.adoc[]
:leveloffset: -1
endif::[]

== License

This software is licensed under link:LICENSE[APL 2.0]

