= Getting started

ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
:toc-placement: preamble
endif::[]


== Getting started

=== DSL

[source,java,linenum]
----
SpecificationBuilder feedBuilder = Specification.start("", "loop")
        .configure(context()
                .topic("topic")
                .variable("nextPosition", "${contentStream.hasLastPosition() ? contentStream.lastPosition() : 1}")
        )
        .function(paginate("loop")
                .variable("fromPosition", "${nextPosition}")
                .addPageContent()
                .iterate(execute("page"))
                .prefetchThreshold(15)
                .until(whenVariableIsNull("nextPosition"))
        )
        .function(get("page")
                .url("http://example.com/feed?pos=${fromPosition}&size=10")
                .validate(status().success(200, 299))
                .pipe(sequence(xpath("/feed/entry"))
                        .expected(xpath("/entry/id"))
                )
                .pipe(nextPage()
                        .output("nextPosition", regex(xpath("/feed/link[@rel=\"next\"]/@href"), "(?<=[?&]pos=)[^&]*"))
                )
                .pipe(parallel(xpath("/feed/entry"))
                        .variable("position", xpath("/entry/id"))
                        .pipe(addContent("${position}", "entry"))
                        .pipe(publish("${position}"))
                )
                .returnVariables("nextPosition")
        );
----

=== Run

[source,java,linenum]
----
Worker.newBuilder()
        .configuration(Map.of(
                "content.stream.connector", "rawdata",
                "rawdata.client.provider", "memory")
        )
        .specification(feedBuilder)
        .printExecutionPlan()
        .build()
        .run();
----